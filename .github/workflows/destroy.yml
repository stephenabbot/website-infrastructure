name: Destroy Infrastructure

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DESTROY" (all caps) to confirm destruction'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  TOFU_VERSION: 1.10.7

jobs:
  destroy:
    name: Destroy Static Website Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm }}" != "DESTROY" ]; then
            echo "Destruction not confirmed. Please type 'DESTROY' (all caps) to confirm."
            exit 1
          fi
          echo "WARNING: This will permanently delete all infrastructure!"
          echo "Proceeding with destruction..."

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Debug OIDC Configuration
        run: |
          echo "=== OIDC DEBUG INFO ==="
          echo "AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}"
          echo "Repository: ${{ github.repository }}"
          echo "Expected role: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/gharole-website-infrastructure-prd"
          echo "GitHub token issuer: $ACTIONS_ID_TOKEN_REQUEST_TOKEN"
          echo "GitHub token URL: $ACTIONS_ID_TOKEN_REQUEST_URL"
          
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/gharole-website-infrastructure-prd
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: website-infrastructure-destroy-${{ github.run_id }}
          role-duration-seconds: 3600

      - name: Verify AWS identity
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity
          echo "AWS credentials configured successfully"

      - name: Install OpenTofu
        uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: ${{ env.TOFU_VERSION }}

      - name: Get backend configuration from SSM
        id: backend
        run: |
          STATE_BUCKET=$(aws ssm get-parameter --region us-east-1 --name "/terraform/foundation/s3-state-bucket" --query Parameter.Value --output text)
          DYNAMODB_TABLE=$(aws ssm get-parameter --region us-east-1 --name "/terraform/foundation/dynamodb-lock-table" --query Parameter.Value --output text)
          GITHUB_REPO=$(echo "${{ github.repository }}" | tr '/' '-')
          BACKEND_KEY="static-website-infrastructure/${GITHUB_REPO}/terraform.tfstate"
          
          echo "state_bucket=$STATE_BUCKET" >> $GITHUB_OUTPUT
          echo "dynamodb_table=$DYNAMODB_TABLE" >> $GITHUB_OUTPUT
          echo "backend_key=$BACKEND_KEY" >> $GITHUB_OUTPUT
          echo "Backend configuration retrieved:"
          echo "  Bucket: $STATE_BUCKET"
          echo "  DynamoDB: $DYNAMODB_TABLE"
          echo "  Key: $BACKEND_KEY"

      - name: Initialize OpenTofu
        run: |
          tofu init \
            -backend-config="bucket=${{ steps.backend.outputs.state_bucket }}" \
            -backend-config="key=${{ steps.backend.outputs.backend_key }}" \
            -backend-config="region=us-east-1" \
            -backend-config="dynamodb_table=${{ steps.backend.outputs.dynamodb_table }}" \
            -reconfigure

      - name: Plan destruction
        run: tofu plan -destroy -out=destroy-plan

      - name: Apply destruction
        run: tofu apply -auto-approve destroy-plan

      - name: Clean up SSM parameters
        run: |
          echo "Cleaning up SSM parameters..."

          # List and delete all static-website infrastructure parameters
          PARAMS=$(aws ssm get-parameters-by-path \
            --path "/static-website/infrastructure" \
            --recursive \
            --query 'Parameters[*].Name' \
            --output text 2>/dev/null || echo "")

          if [ -n "$PARAMS" ]; then
            for param in $PARAMS; do
              echo "Deleting parameter: $param"
              aws ssm delete-parameter --name "$param" 2>/dev/null || true
            done
            echo "SSM parameters cleaned up"
          else
            echo "No SSM parameters found to clean up"
          fi

      - name: Summary
        run: |
          echo "============================================"
          echo "DESTRUCTION COMPLETE"
          echo "============================================"
          echo ""
          echo "All static website infrastructure has been destroyed."
          echo ""
          echo "Manual cleanup may be required for:"
          echo "  - S3 bucket contents (if versioning retained objects)"
          echo "  - Route53 hosted zone NS records in parent domain"
          echo "  - Any external DNS configurations"
